<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="css/checkout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <!-- REQUIRE LOGIN BEFORE CHECKOUT -->
    <script>
        (function() {
            // Check authentication immediately before page loads
            fetch('includes/auth_session.php', { credentials: 'same-origin' })
                .then(function(r) { return r.json(); })
                .then(function(session) {
                    if (!session || !session.authenticated) {
                        // Not logged in - redirect to login with return URL
                        var returnUrl = encodeURIComponent(window.location.href);
                        window.location.href = 'login.html?redirect=' + returnUrl + '&message=' + encodeURIComponent('Please log in to checkout');
                    }
                })
                .catch(function() {
                    // Error checking session - redirect to login
                    var returnUrl = encodeURIComponent(window.location.href);
                    window.location.href = 'login.html?redirect=' + returnUrl;
                });
        })();
    </script>
</head>
<body>
    <div class="checkout-bg" style="background: url('./images/background-checkout.png') ">
        <header style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
            <h3>Checkout</h3>
            <div class="header_actions" style="display:flex;align-items:center;gap:12px;justify-content:flex-end;">
                <a href="javascript:history.back()" class="back-button">
                    <div class="go-back-box">Go Back</div>
                </a>
                <a href="login.html" class="top_panel_login_button sc_button sc_button_style_filled sc_button_size_small" style="padding:6px 14px;">Login / Register</a>
                <a href="user-profile.php" class="user_icon_button sc_button sc_button_style_border sc_button_size_small" style="padding:6px 10px;display:none;align-items:center;justify-content:center;border-radius:50%;width:34px;height:34px;" title="Account">
                    <span class="user_initial" style="font-weight:600;">U</span>
                </a>
            </div>
        </header>

        <main>
            <section class="checkout-form">
                <!-- Multistep Form -->
                <form id="msform">
                    <!-- Progressbar -->
                    <ul id="progressbar">
                        <li class="active">Contact Information</li>
                        <li>Shipping Address</li>
                        <li>Payment</li>
                    </ul>
                    <!-- Fieldsets -->
                    <fieldset>
                        <h2 class="fs-title">Contact Information</h2>
                        
                        <p>First Name *</p>
                        <input type="text" name="fname" placeholder="First Name" required />
                        <p>Last Name *</p>
                        <input type="text" name="lname" placeholder="Last Name" required />
                      
                        <p>Email *</p>
                        <input type="email" name="email" placeholder="Email" required />
                        <p>Phone *</p>
                        <input type="tel" name="phone" placeholder="Phone Number" required />
                        <input type="button" name="next" class="next action-button" value="Next" />
                    </fieldset>   
                    <fieldset>
                        <h2 class="fs-title">Shipping Address</h2>
                       
                        <p>Address *</p>
                        <input type="text" name="address" placeholder="Street Address" required />
                        <p>Address Line 2</p>
                        <input type="text" name="address2" placeholder="Apartment, suite, etc. (optional)" />
                        <div class="state-city-container">
                            <div class="state-container">
                                <p>State *</p>
                                <select name="state" id="state-dropdown" required>
                                    <option value="" disabled selected>Select your state</option>
                                    <option value="Pahang">Pahang</option>
                                    <option value="Perak">Perak</option>
                                    <option value="Terengganu">Terengganu</option>
                                    <option value="Perlis">Perlis</option>
                                    <option value="Selangor">Selangor</option>
                                    <option value="Negeri Sembilan">Negeri Sembilan</option>
                                    <option value="Johor">Johor</option>
                                    <option value="Kelantan">Kelantan</option>
                                    <option value="Kedah">Kedah</option>
                                    <option value="Pulau Pinang">Pulau Pinang</option>
                                    <option value="Melaka">Melaka</option>
                                    <option value="Sabah">Sabah</option>
                                    <option value="Sarawak">Sarawak</option>
                                </select>
                            </div>
                            <div class="city-container">
                                <p>City *</p>
                                <input type="text" name="city" id="city-input" placeholder="City" required />
                            </div>
                        </div>
                        <p>Postal Code *</p>
                        <input type="text" name="postal_code" placeholder="Postal Code" required />
                        <div class="action-buttons">
                            <input type="button" name="previous" class="previous action-button" value="Previous" />
                            <input type="button" name="next" class="next action-button" value="Next" />
                        </div>
                    </fieldset>
                    <fieldset>
                        <h2 class="fs-title">Payments</h2>


                        <p style="margin-bottom:10px;">Select Payment Method *</p>
                        <div class="checkout-options padded">
                            <div>
                                <input type="radio" id="option-1" name="payment-option" value="stripe" tabindex="0" required>
                                <label for="option-1" class="checkout-option rounded text text--dark">
                                    <i class="fas fa-credit-card payment-icon"></i>
                                    <span class="checkout-option-name">Credit Card</span>
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="option-2" name="payment-option" value="paypal" tabindex="0">
                                <label for="option-2" class="checkout-option rounded text text--dark">
                                    <i class="fab fa-paypal payment-icon"></i>
                                    <span class="checkout-option-name">PayPal</span>
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="option-3" name="payment-option" value="fpx" tabindex="0">
                                <label for="option-3" class="checkout-option rounded text text--dark">
                                    <i class="fas fa-university payment-icon"></i>
                                    <span class="checkout-option-name">FPX</span>
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="option-4" name="payment-option" value="manual" tabindex="0">
                                <label for="option-4" class="checkout-option rounded text text--dark">
                                    <i class="fas fa-wallet payment-icon"></i>
                                    <span class="checkout-option-name">Manual Payment</span>
                                </label>
                            </div>
                        </div>

                        <hr class="divider">
                        
                        <div class="action-buttons">
                            <input type="button" name="previous" class="previous action-button" value="Previous" />
                            <button type="button" class="submit action-button" id="submit-order-btn">Place Order</button>
                        </div>
                    </fieldset>
                </form>
            </section>

            <section class="checkout-details">
                <div class="checkout-details-inner">
                    <div class="checkout-lists" id="checkout-items"></div>
                    <div class="checkout-shipping">
                        <h6>Shipping</h6>
                        <p class="shipping-price" data-shipping-price="5.99">RM5.99</p>
                    </div>
                    <div class="checkout-total">
                        <h6>Total</h6>
                        <p class="order-total" id="checkout-order-total">RM0.00</p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
          
        </footer>
    </div>
    <script>
        var current_fs, next_fs, previous_fs; // Fieldsets
        var animating = false; // Prevent quick multi-click glitches

        $(".next").click(function () {
            if (animating) return false;

            // Find the parent fieldset of the button
            current_fs = $(this).closest("fieldset");
            next_fs = current_fs.next();

            // Activate next step on progress bar
            $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");

            // Show the next fieldset and hide the current one
            current_fs.css({ display: "none" });
            next_fs.css({ display: "block" });
        });

        $(".previous").click(function () {
            if (animating) return false;

            // Find the parent fieldset of the button
            current_fs = $(this).closest("fieldset");
            previous_fs = current_fs.prev();

            // Deactivate current step on progress bar
            $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");

            // Show the previous fieldset and hide the current one
            current_fs.css({ display: "none" });
            previous_fs.css({ display: "block" });
        });

        $("form").submit(function (e) {
            e.preventDefault();
            alert("Order placed! (Demo â€“ no backend)");
        });

        // Render checkout items from localStorage cart and keep totals in sync
        (function(){
            function safeParse(v){ try { return JSON.parse(v||'[]'); } catch(e){ return []; } }
            function getCart(){ return safeParse(localStorage.getItem('cart')); }
            function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }
            function parsePrice(txt){ if(!txt) return 0; var n = String(txt).replace(/[^0-9.]/g,''); var f = parseFloat(n); return isNaN(f)?0:f; }
            function format(n){ return 'RM' + Number(n||0).toFixed(2); }
            // Fallback name/price maps (kept minimal). If PRODUCT_PRICING exists, we don't need these usually.
            var fallbackNames = { 458:"Evaporated Milk",448:"Farm Sour Cream",438:"Ricotta Salata",412:"Parmesan Cheese",471:"Pecorino Romano",364:"Tested Raw Milk",402:"Brie Cheese",426:"Fromage a Raclette",387:"Camembert Cheese",420:"Fresh Milk",430:"Butter",450:"Yogurt",460:"Chicken Eggs",470:"Duck Eggs",480:"Quail Eggs",490:"Beef",500:"Pork",510:"Chicken",520:"Lamb",530:"Bacon",540:"Sausage" };
            var fallbackPrices = { 458:23.00,448:25.00,438:50.00,412:35.00,471:45.00,364:10.00,402:30.00,426:45.00,387:35.00,420:3.50,430:8.50,450:5.50,460:3.50,470:5.00,480:6.50,490:18.00,500:12.00,510:6.00,520:20.00,530:18.00,540:15.00 };
            function normalize(raw){
                var id = raw.id || raw.productId;
                var qty = raw.qty || raw.quantity || 1;
                var price = typeof raw.price==='number' ? raw.price : parsePrice(raw.price);
                if ((!price || price===0) && id!=null && fallbackPrices[id]!=null) price = fallbackPrices[id];
                var title = raw.title || fallbackNames[id] || 'Product';
                var image = raw.image || raw.img || '';
                var variant = raw.variant || raw.variation || '';
                return { id:id, qty:qty, price:price, title:title, image:image, variant:variant };
            }
            function render(){
                var list = document.getElementById('checkout-items');
                if (!list) return;
                var cart = getCart().map(normalize);
                if (!cart.length){
                    list.innerHTML = '<p>Your cart is empty.</p>';
                    updateTotals(cart);
                    return;
                }
                var html = '';
                cart.forEach(function(it){
                    var variantText = it.variant ? ' <small>(' + it.variant + ')</small>' : '';
                    html += '\n<div class="card" data-id="' + it.id + '" data-variant="' + (it.variant||'') + '">\n' +
                            '  <div class="card-image">' + (it.image ? '<img src="' + it.image + '" alt="' + (it.title||'') + '">' : '') + '</div>\n' +
                            '  <div class="card-details">\n' +
                            '    <div class="card-name">' + (it.title || 'Product') + variantText + '</div>\n' +
                            '    <div class="card-price">\n' +
                            '      <span class="current-price">' + format(it.price) + '</span>\n' +
                            '    </div>\n' +
                            '    <div class="card-wheel">\n' +
                            '      <button type="button" class="qty-btn" data-action="dec" aria-label="Decrease quantity">-</button>\n' +
                            '      <span class="qty" aria-live="polite">' + (it.qty||1) + '</span>\n' +
                            '      <button type="button" class="qty-btn" data-action="inc" aria-label="Increase quantity">+</button>\n' +
                            '    </div>\n' +
                            '  </div>\n' +
                            '</div>';
                });
                list.innerHTML = html;
                updateTotals(cart);
            }
            function updateTotals(cart){
                cart = cart || getCart().map(normalize);
                var subtotal = cart.reduce(function(s,it){ return s + (it.price||0) * (it.qty||1); }, 0);
                var shippingEl = document.querySelector('.shipping-price');
                var shipping = 0;
                if (shippingEl){
                    var raw = parseFloat(shippingEl.getAttribute('data-shipping-price'))||0;
                    shipping = cart.length ? raw : 0;
                    shippingEl.textContent = format(shipping);
                }
                var totalEl = document.getElementById('checkout-order-total');
                if (totalEl) totalEl.textContent = format(subtotal + shipping);
            }
            function adjustQty(id, variant, delta){
                var cart = getCart();
                var idx = cart.findIndex(function(r){ var rid = r.id||r.productId; var v = r.variant||r.variation||''; return String(rid)===String(id) && String(v)===String(variant||''); });
                if (idx === -1) return;
                var item = cart[idx];
                var qty = (item.qty || item.quantity || 1) + delta;
                if (qty <= 0) { cart.splice(idx,1); } else { item.qty = qty; }
                saveCart(cart);
                render();
            }
            document.addEventListener('click', function(e){
                var btn = e.target.closest && e.target.closest('#checkout-items .qty-btn');
                if (!btn) return;
                var action = btn.getAttribute('data-action');
                var card = btn.closest('.card');
                if (!card) return;
                var id = card.getAttribute('data-id');
                var variant = card.getAttribute('data-variant') || '';
                adjustQty(id, variant, action==='inc' ? 1 : -1);
            });
            render();
        })();
    </script>
    <!-- Global cart script so checkout can reflect the mini-cart/cart totals -->
    <script type='text/javascript' src='js/local-cart.js'></script>
    <script type='text/javascript' src='js/cart-api.js'></script>
    <script type='text/javascript' src='js/mini-cart.js'></script>
    <script type='text/javascript' src='js/product-data.js'></script>
    <script type='text/javascript' src='js/auth-session.js'></script>
    <script type='text/javascript' src='js/checkout.js'></script>
</body>
</html>